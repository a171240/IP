<view class="page page-factory">
  <view class="container">
    <view class="hero fade-up">
      <text class="title">IP 工作流</text>
      <text class="subtitle">P1-P10 全流程（可循环复用）</text>

      <view class="row space-between" style="margin-top: 18rpx;">
        <view class="chip">{{planLabel || "未登录"}}</view>
        <view class="chip">{{creditsLabel || "积分 --"}}</view>
      </view>

      <view class="hero-actions">
        <button class="btn-outline" bindtap="handleGoPay">升级/购买</button>
      </view>
    </view>

    <view class="section fade-up delay-1" wx:if="{{loading}}">
      <view class="card">
        <text class="muted small">加载中...</text>
      </view>
    </view>

    <view class="section fade-up delay-1" wx:for="{{phases}}" wx:key="phase">
      <text class="section-title">{{item.phaseName}} · {{item.phaseSubtitle}}</text>

      <view class="grid-2">
        <view class="card action-card" wx:for="{{item.steps}}" wx:key="id">
          <view class="row action-row">
            <view class="action-icon">{{item.id}}</view>
            <view class="action-meta">
              <text class="card-title">{{item.title}}</text>
              <text class="muted small">{{item.output}}</text>
            </view>
          </view>

          <text class="muted small">{{item.description}}</text>

          <view class="row" style="margin-top: 12rpx;">
            <text class="tag">{{item.requiredPlanLabel}}</text>
            <text class="tag {{item.statusClass}}">{{item.statusLabel}}</text>
          </view>

          <text
            class="muted small"
            wx:if="{{item.missingDepsLabel}}"
            style="margin-top: 8rpx; display: block;"
          >
            缺少前置：{{item.missingDepsLabel}}
          </text>

          <view class="row" style="margin-top: 12rpx;">
            <button class="btn-primary" size="mini" bindtap="handleOpenStep" data-id="{{item.id}}">
              {{item.completed ? "重新生成" : "开始"}}
            </button>
            <button
              class="btn-outline"
              size="mini"
              wx:if="{{item.reportId}}"
              bindtap="handleOpenReport"
              data-report="{{item.reportId}}"
            >
              查看
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
