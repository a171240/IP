<view class="page page-workspace">
  <view class="container">
    <view class="hero fade-up">
      <text class="title">内容工作台 V2</text>
      <text class="subtitle">提取链接 -> 改写 -> 生成视频 -> 一键分发</text>
    </view>

    <view class="section fade-up delay-1">
      <view class="card">
        <text class="card-title">1. 粘贴链接并提取</text>
        <textarea
          class="input textarea"
          placeholder="粘贴抖音或小红书链接"
          auto-height
          value="{{sourceUrl}}"
          bindinput="onSourceUrlInput"
        />
        <button class="btn-primary" bindtap="handleIngest" loading="{{ingestLoading}}">
          提取内容
        </button>

        <view wx:if="{{sourceId}}" style="margin-top: 16rpx;">
          <text class="muted small">Source ID：{{sourceId}}</text>
          <text class="card-title" style="margin-top: 10rpx;">{{sourceTitle || "未识别标题"}}</text>
          <text class="muted small">{{sourceAuthor ? ("作者：" + sourceAuthor) : "作者：-"}}</text>
          <text class="small" style="margin-top: 12rpx; display: block;">{{sourceText || "暂无正文"}}</text>
        </view>
      </view>
    </view>

    <view class="section fade-up delay-1">
      <view class="card">
        <text class="card-title">2. 改写为视频脚本</text>
        <button class="btn-primary" bindtap="handleRewrite" loading="{{rewriteLoading}}">
          生成改写结果
        </button>

        <view wx:if="{{rewriteId}}" style="margin-top: 16rpx;">
          <text class="muted small">Rewrite ID：{{rewriteId}}</text>
          <text class="card-title" style="margin-top: 10rpx;">{{rewriteTitle || "未命名改写"}}</text>
          <text class="small" style="margin-top: 12rpx; display: block;">{{rewriteBody || rewriteScript || "暂无内容"}}</text>
          <text wx:if="{{rewriteTags}}" class="muted small" style="margin-top: 10rpx; display: block;">
            标签：{{rewriteTags}}
          </text>
        </view>
      </view>
    </view>

    <view class="section fade-up delay-2">
      <view class="card">
        <text class="card-title">3. 生成视频</text>
        <input
          class="input"
          placeholder="头像档案 ID（avatar_profile_id）"
          value="{{avatarProfileId}}"
          bindinput="onAvatarProfileInput"
        />
        <button class="btn-outline" bindtap="handleGenerateVideo" loading="{{videoLoading}}">
          生成视频
        </button>
        <button class="btn-outline" bindtap="handleOpenVideoJobs" wx:if="{{videoJobId}}">
          查看视频任务
        </button>
        <text wx:if="{{videoJobId}}" class="muted small" style="margin-top: 12rpx; display: block;">
          Video Job ID：{{videoJobId}}
        </text>
      </view>
    </view>

    <view class="section fade-up delay-2">
      <view class="card">
        <text class="card-title">4. 一键分发</text>
        <text class="muted small">选择平台</text>
        <view class="row" style="margin-top: 10rpx;">
          <view class="tag {{platformSelection.xiaohongshu ? 'tag-accent' : ''}}" data-platform="xiaohongshu" bindtap="onTogglePlatform">
            小红书
          </view>
          <view class="tag {{platformSelection.douyin ? 'tag-accent' : ''}}" data-platform="douyin" bindtap="onTogglePlatform">
            抖音
          </view>
          <view class="tag {{platformSelection.video_account ? 'tag-accent' : ''}}" data-platform="video_account" bindtap="onTogglePlatform">
            视频号
          </view>
        </view>

        <text class="muted small" style="margin-top: 10rpx; display: block;">发布模式</text>
        <view class="row" style="margin-top: 10rpx;">
          <button size="mini" class="{{distributionMode === 'immediate' ? 'btn-primary' : 'btn-outline'}}" bindtap="onModeImmediate">
            立即发布
          </button>
          <button size="mini" class="{{distributionMode === 'scheduled' ? 'btn-primary' : 'btn-outline'}}" bindtap="onModeScheduled">
            定时发布
          </button>
        </view>

        <view wx:if="{{distributionMode === 'scheduled'}}" style="margin-top: 12rpx;">
          <picker mode="date" value="{{scheduleDate}}" bindchange="onScheduleDateChange">
            <view class="input">{{scheduleDate || "选择日期"}}</view>
          </picker>
          <picker mode="time" value="{{scheduleTime}}" bindchange="onScheduleTimeChange">
            <view class="input">{{scheduleTime || "选择时间（Asia/Shanghai）"}}</view>
          </picker>
        </view>

        <button class="btn-primary" bindtap="handleDistribute" loading="{{distributeLoading}}">
          提交分发
        </button>
        <button class="btn-outline" bindtap="handleOpenVideoJobs" wx:if="{{distributeJobId}}">
          查看任务中心
        </button>

        <view wx:if="{{distributeJobId}}" style="margin-top: 14rpx;">
          <text class="muted small">Job ID：{{distributeJobId}}</text>
          <view wx:for="{{distributeTasks}}" wx:key="platform" class="row" style="margin-top: 8rpx;">
            <text class="tag">{{item.platform}}</text>
            <text class="tag">{{item.mode}}</text>
            <text class="tag {{item.status === 'done' ? 'tag-success' : item.status === 'failed' ? 'tag-accent' : ''}}">
              {{item.status}}
            </text>
          </view>
        </view>
      </view>
    </view>

    <view wx:if="{{lastError}}" class="section">
      <view class="card">
        <text class="muted small">最近错误：{{lastError}}</text>
      </view>
    </view>
  </view>
</view>
